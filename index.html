var express = require('express')
var os = require("os");
const mysql = require('mysql')

// import my javascript file that contains functions necessary
var DatabaseSql = require("./DatabaseSql");

var app = express();

var requests_counter = 0;
var counter = 0;

// connect to database
const connection = mysql.createConnection({
  host: 'localhost',
  user: 'root',
  password: 'root',
  database: 'proj2023'
})

connection.connect()

app.listen(3000, () => {
    console.log('server is listening')
    // server_views_counter++;
    // console.log('server accessed : ' + server_views_counter + 'times')
})

app.use((req, res, next) => {
    res.counter = ++counter
    console.log('server accessed : ' + res.counter)
    next()
})

app.get('/', (req, res) => {
    console.log("/ Route");
    res.send('<ul><li><a href="/stores">Stores</a></li> <li><a href="/products">Products</a></li> <li><a href="/managers">Managers (Mongo DB)</a></li></ul>')
})

app.get('/stores', (req, res) => {

    html = '<h1>Stores</h1><br/><a href="/">Add Store</a><table border="1px">'
    html = html + '<tr><th>SID</th> <th>Location</th> <th>Manager ID</th> <th>Action</th></tr>'

    connection.query('select * from store', (err, rows, fields) => {

    arrayLength = rows.length;
    for (var i = 0; i < arrayLength; i++) {
        html = html + '<tr> <td>' + rows[i]["sid"] + '</td> <td>' + rows[i]["location"] + '</td> <td>' + rows[i]["mgrid"] + '</td>' + '<td><a href="/stores/edit/' + rows[i]['sid'] + '">Update</a></td>' + '</tr>'
    }

    html = html + '</table><br/><a href="/">Home</a>'
    res.send(html);
    })
    
})

app.get("/stores/edit/:sid", (req, res) => {

    sid = req.params['sid']
    query = 'select * from store where sid ="' + sid + '"'
    connection.query(query, (err, rows, fields) => {

    mgrid = rows[0]['mgrid']
    location = rows[0]['location']

    console.log(mgrid)
    
    res.send('<h1>Edit Store</h1><br/> <p>SID <input disabled value="' + req.params['sid'] + '" type="text" /></p><p>Location <input type="text" value="' + location + '" /></p><p>Manager ID <input type="text" value="' + mgrid + '" /></p> <button>Add</button> <br/><br/> <a href="/">Home</a>');

    })
})

app.get('/products', (req, res) => {

    connection.query('SELECT p.pid, p.productdesc, s.sid, s.location, sct.Price FROM product p INNER JOIN product_store sct ON p.pid = sct.pid INNER JOIN store s;', (err, rows, fields) => {

    html = '<h1>Products</h1><br/><table border="1px">'
    html = html + '<tr><th>Product ID</th> <th>Description</th> <th>Store ID</th> <th>Location</th> <th>Price</th> </th></tr>'
    
    arrayLength = rows.length;
    for (var i = 0; i < arrayLength; i++) {
        html = html + '<tr> <td>' + rows[i]["pid"] + '</td> <td>' + rows[i]["productdesc"] + '</td> <td>' + rows[i]["sid"] + '</td>' + '</td> <td>' + rows[i]["location"]  + '</td> <td>' + rows[i]["Price"] + '</td> </td>' + '<td><a href="/products/delete/' + rows[i]["pid"] + '">Delete ' + rows[i]['productdesc'] + '</a></td>' + '</tr>'
    }

    html = html + '</table><br/><a href="/">Home</a>'
    res.send(html);
    })
})

app.get("/products/delete/:pid", (req, res) => {
    
    //select * from product_store where pid = "MLK2L"
    pid = req.params['pid']
    query = 'select * from product_store where pid ="' + pid + '"'
    connection.query(query, (err, rows, fields) => {

    if(console.log(rows.length) > 0){
        console.log('delete this product')
    }else{
        res.send('<h1>Error Message</h1><br/><br/> <h1>' + req.params['pid'] +  ' is currently in stores and cannot be deleted</h1> <a href="/">Home</a>')
    }

    })
})

app.get('/managers', (req, res) => {
    res.send('<h1>Managers</h1><br/><a href="/">Home</a>');
    // var current_time = new Date;
    // console.log('/details request number :  ' + requests_counter + 'from : ' + os.hostname() + ' at : ' + current_time)
    // requests_counter++;
    // location.href = '/route'
    // res.sendFile(__dirname + '/views/route.html')
})
  
// connection.end()