var express = require('express')
var os = require("os");
const mysql = require('mysql')

var DatabaseSql = require("./DatabaseSql");

var app = express();

var requests_counter = 0;
var counter = 0;

// connect to database
const connection = mysql.createConnection({
  host: 'localhost',
  user: 'root',
  password: 'root',
  database: 'proj2023'
})

connection.connect()

app.listen(3000, () => {
    console.log('server is listening')
    // server_views_counter++;
    // console.log('server accessed : ' + server_views_counter + 'times')
})

app.use((req, res, next) => {
    res.counter = ++counter
    console.log('server accessed : ' + res.counter)
    next()
})

app.get('/', (req, res) => {
    console.log("/ Route");
    res.send('<ul><li><a href="/stores">Stores</a></li> <li><a href="/products">Products</a></li> <li><a href="/managers">Managers (Mongo DB)</a></li></ul>')
})

app.get('/stores', (req, res) => {

    html = '<h1>Stores</h1><br/><a href="/">Add Store</a><table border="1px">'
    html = html + '<tr><th>SID</th> <th>Location</th> <th>Manager ID</th> <th>Action</th></tr>'

    connection.query('select * from store', (err, rows, fields) => {

    arrayLength = rows.length;
    for (var i = 0; i < arrayLength; i++) {
        html = html + '<tr> <td>' + rows[i]["sid"] + '</td> <td>' + rows[i]["location"] + '</td> <td>' + rows[i]["mgrid"] + '</td>' + '<td><a href="">Update</a></td>' + '</tr>'
    }

    html = html + '</table><br/><a href="/">Home</a>'
    res.send(html);
    })
    
})

app.get('/products', (req, res) => {


    connection.query('SELECT p.pid, p.productdesc, s.sid, s.location, sct.Price FROM product p INNER JOIN product_store sct ON p.pid = sct.pid INNER JOIN store s;', (err, rows, fields) => {

    html = '<h1>Products</h1><br/><table border="1px">'
    html = html + '<tr><th>Product ID</th> <th>Description</th> <th>Store ID</th> <th>Location</th> <th>Price</th> </th></tr>'
    
    arrayLength = rows.length;
    for (var i = 0; i < arrayLength; i++) {
        html = html + '<tr> <td>' + rows[i]["pid"] + '</td> <td>' + rows[i]["productdesc"] + '</td> <td>' + rows[i]["sid"] + '</td>' + '</td> <td>' + rows[i]["location"]  + '</td> <td>' + rows[i]["Price"] + '</td> </td>' + '<td><a href="">Delete ' + rows[i]['productdesc'] + '</a></td>' + '</tr>'
    }

    html = html + '</table><br/><a href="/">Home</a>'
    res.send(html);
    })
})

app.get('/managers', (req, res) => {
    res.send('<h1>Managers</h1><br/><a href="/">Home</a>');
    // var current_time = new Date;
    // console.log('/details request number :  ' + requests_counter + 'from : ' + os.hostname() + ' at : ' + current_time)
    // requests_counter++;
    // location.href = '/route'
    // res.sendFile(__dirname + '/views/route.html')
})
  
// connection.end()